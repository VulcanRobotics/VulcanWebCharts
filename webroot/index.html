<!doctype html>
<html>

<head>
    <title>Vulcan Web Charts</title>
    <script src="Chart.js"></script>
    <style>
    canvas{
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    </style>
</head>

<body>
    <div>
      <div align="center">
        <img src="img/icon.png" style="width:5%" ></img>
      </div>

      <div align="center">
        <h1> Vulcan Web Charts </h1>
      </div>
    </div>
    <div id="options" style="width:10%" align="center">

    </div>
    <div style="width:90%;float:right">
        <canvas id="canvas"></canvas>
    </div>

    <script>
    var setpointColor = "#FF0000"
    var velocityColor = "#66CCFF"
    var errorColor = "#00FF00"
    var voltageColor = "#8B008B"
    var positionColor = "#0000FF"
    var chartName = {
        display:true,
        text:""
    };
    var config;
    var modes = {};
    var xAxisLabels = [];
    var setpoints = [];
    var velocitys = [];
    var errors = [];
    var voltages = [];
    var positions = [];
    var loopChartConfig = {
        type: 'line',
        data: {
            labels: xAxisLabels,
            datasets: [{
                yAxisID: "Velocity",
                label: "Setpoint",
                backgroundColor: setpointColor,
                borderColor: setpointColor,
                data: setpoints,
                fill: false,
            }, {
                yAxisID: "Velocity",
                label: "Velocity",
                fill: false,
                backgroundColor: velocityColor,
                borderColor: velocityColor,
                data: velocitys,
            }, {
                yAxisID: "Velocity",
                label: "Error",
                fill: false,
                backgroundColor: errorColor,
                borderColor: errorColor,
                data: errors,
            },{
                yAxisID: "Voltage",
                label: "Output Voltage",
                fill: false,
                backgroundColor: voltageColor,
                borderColor: voltageColor,
                data: voltages,
            },{
                yAxisID: "Position",
                label: "Position",
                fill: false,
                backgroundColor: positionColor,
                borderColor: positionColor,
                data: positions,
            }]
        },
        options: {
            responsive: true,
            title:chartName,
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'milliseconds'
                    }
                }],
                yAxes: [{
                    display: true,
                    id: "Velocity",
                    position: "left",
                    scaleLabel: {
                        display: true,
                        labelString: 'encoder counts per 100 milliseconds'
                    }
                  },{
                    display: true,
                    id: "Voltage",
                    position: "right",
                    scaleLabel: {
                        display: true,
                        labelString: 'Volts'
                    }
                  },{
                    display: true,
                    id: "Position",
                    position: "right",
                    scaleLabel: {
                        display: true,
                        labelString: 'encoder counts'
                    }
                  }]
            }
        }
    };

    loopLine = new Chart(document.getElementById("canvas").getContext("2d"), loopChartConfig);

    console.log("Fetching config");
    fetch("/webroot/config.json",{cache:"no-store"}).then(function(response){
      return response.json()
    }).then(function(configJ){
      console.log("Configing TalonSRX Options");
      config = configJ
      for(i = 0; i < config.talonSRX.length; i++){
        var line = "<button type=\"button\" onclick=\"plotLog('talonSRX/" + config.talonSRX[i].name + ".json')\">"
        line += config.talonSRX[i].name;
        line += "</button>\n";
        modes[config.talonSRX[i].name] = config.talonSRX[i].mode;
        document.getElementById("options").innerHTML += line;
      }
    });

    function plotLog(path){
      console.log("Fetching " + path);
      fetch(("../log/" + path),{cache: "no-store"}).then(function(response){
        return response.json()
      }).then(function(data){
        setpoints.length = 0;
        velocitys.length = 0;
        errors.length = 0;
        xAxisLabels.length = 0;
        voltages.length = 0;
        positions.length = 0;
        console.log("Sucessfuly fetched " + path + ", generating chart.");
        var nameArr = path.split('/');
        var name = nameArr[nameArr.length - 1];
        name = name.substring(0,name.length-5);
        loopChartConfig.options.title.text = name;
        mode = modes[name];
        var count = data.setpoint.length;

        for (i = 0; i <= count; i++){
          xAxisLabels.push(i*20);
          setpoints.push({x:data.timeStamp[i],y:data.setpoint[i]});
          velocitys.push({x:data.timeStamp[i],y:data.velocity[i]});
          errors.push({x:data.timeStamp[i],y:data.error[i]});
          voltages.push({x:data.timeStamp[i],y:data.vOut[i]});
          positions.push({x:data.timeStamp[i],y:data.position[i]});
        }
        loopLine.update(loopChartConfig);
        console.log("done");
      });
    }
    </script>
<!-- <p>xAxisLegend</p> -->
</body>

</html>
